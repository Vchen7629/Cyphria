- name: Delete Cloudflare secret for external-dns
  kubernetes.core.k8s:
    state: absent
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: cloudflare-api
        namespace: external-dns
        
- name: Delete external-dns namespace
  kubernetes.core.k8s:
    state: absent
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: external-dns

- name: Uninstall External DNS Policies in argocd
  kubernetes.core.k8s:
    api_version: argoproj.io/v1alpha1
    state: absent
    kind: Application
    name: external-dns
    namespace: argocd

- name: Delete secret
  ansible.builtin.command:
    cmd: kubectl delete secrets cloudflare-api -n external-dns
  ignore_errors: true